<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>勤怠管理</title>
</head>
<body>
    <!-- 管理者画面の場合 -->
    <h1 th:if="${mode == 'manager'}">勤怠管理（管理者画面）</h1>
    <!-- 従業員画面の場合 -->
    <h1 th:if="${mode == 'employee'}">勤怠管理（従業員画面）</h1>
    
    <div>
        <!-- 管理者の場合は従業員の追加ボタン -->
        <span th:if="${mode == 'manager'}">
            <button onclick="addEmployee()">従業員の追加</button> 
        </span>
        
        <!-- 管理者と従業員モードによって遷移URL変わる -->
        <a th:if="${mode == 'manager'}" th:href="@{/manager}">管理者画面に戻る</a>
        <a th:if="${mode == 'employee'}" th:href="@{/}">勤怠管理システムに戻る</a>
    </div>
    
    <br>
    
    <table border="1" id="attendanceTable">
        <thead>
            <tr>
                <th>名前</th>
                <th>状況</th>
                <th>出勤時刻</th>
                <th>退勤時刻</th>
                <!-- 管理者モードの場合は編集・削除ボタン -->
                <th th:if="${mode == 'manager'}">編集</th>
                <th th:if="${mode == 'manager'}">削除</th>
                <!-- 従業員モードの場合は編集ボタンのみ -->
                <th th:if="${mode == 'employee'}">操作</th>
            </tr>
        </thead>
        <tbody>
            <!-- データベースからの実際の従業員データを表示 -->
            <tr th:each="employee : ${employeeList}" th:data-id="${employee.nameId}">
                <td class="name" th:text="${employee.name}">名前</td>
                <td class="status">
                    <!-- 出勤状況の判定 -->
                    <span>未出勤</span>
                </td>
                <td class="checkin">-</td>
                <td class="checkout">-</td>
                
                <!-- 管理者モード：編集（画面遷移）・削除（AJAX）ボタン -->
                <td th:if="${mode == 'manager'}">
                    <form th:action="@{/attendance-change-form}" method="get" style="display: inline;">
                        <input type="hidden" name="nameId" th:value="${employee.nameId}">
                        <input type="hidden" name="name" th:value="${employee.name}">
                        <button type="submit">編集</button>
                    </form>
                </td>
                <td th:if="${mode == 'manager'}">
                    <button onclick="deleteAttendance(this)" 
                            th:data-name-id="${employee.nameId}" 
                            th:data-name="${employee.name}">削除</button>
                </td>
                
                <!-- 従業員モード：変更申請 -->
                <td th:if="${mode == 'employee'}">
                    <form th:action="@{/attendance-change-form}" method="get" style="display: inline;">
                        <input type="hidden" name="nameId" th:value="${employee.nameId}">
                        <input type="hidden" name="name" th:value="${employee.name}">
                        <button type="submit">変更申請</button>
                    </form>
                </td>
            </tr>
            
            <!-- データがない場合 -->
            <tr th:if="${employeeList == null or #lists.isEmpty(employeeList)}">
                <td colspan="7" style="text-align: center;">従業員データがありません</td>
            </tr>
        </tbody>
    </table>

    <!-- 管理者モードの場合のみJavaScript -->
    <script th:if="${mode == 'manager'}">
        // 従業員追加機能（テスト用）
        function addEmployee() {
            alert('従業員追加機能（DAOが完成したら実装）');
        }

        // AJAX削除機能
        function deleteAttendance(button) {
            const nameId = button.getAttribute('data-name-id');
            const name = button.getAttribute('data-name');
            
            if (confirm('本当に ' + name + 'さん を削除しますか？')) {
                // 実際のAJAX呼び出し
                fetch('/api/delete-attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        nameId: nameId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        // 削除成功：ページをリロード
                        location.reload();
                    } else {
                        alert('削除に失敗しました: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('エラーが発生しました: ' + error);
                });
            }
        }
    </script>
</body>
</html>